package xbox360_test

import (
	"context"
	"io"
	"testing"
	"time"

	"github.com/Alia5/VIIPER/apiclient"
	"github.com/Alia5/VIIPER/device/xbox360"
	"github.com/Alia5/VIIPER/internal/server/api"
	"github.com/Alia5/VIIPER/internal/server/api/handler"
	viiperTesting "github.com/Alia5/VIIPER/testing"
	"github.com/Alia5/VIIPER/usbip"
	"github.com/Alia5/VIIPER/virtualbus"
	"github.com/stretchr/testify/assert"

	_ "github.com/Alia5/VIIPER/internal/registry" // Register devices
)

func TestInputReports(t *testing.T) {

	type testCase struct {
		name           string
		inputState     xbox360.InputState
		expectedReport []byte
	}

	cases := []testCase{
		{
			name: "button dpad up",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonDPadUp,
			},
			expectedReport: []byte{0x00, 0x14, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},
		{
			name: "button dpad down",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonDPadDown,
			},
			expectedReport: []byte{0x00, 0x14, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button dpad left",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonDPadLeft,
			},
			expectedReport: []byte{0x00, 0x14, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button dpad right",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonDPadRight,
			},
			expectedReport: []byte{0x00, 0x14, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button start",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonStart,
			},
			expectedReport: []byte{0x00, 0x14, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button back",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonBack,
			},
			expectedReport: []byte{0x00, 0x14, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button lthumb",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonLThumb,
			},
			expectedReport: []byte{0x00, 0x14, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button rthumb",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonRThumb,
			},
			expectedReport: []byte{0x00, 0x14, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button lshoulder",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonLShoulder,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button rshoulder",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonRShoulder,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button guide",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonGuide,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button a",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonA,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button b",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonB,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button x",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonX,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "button y",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonY,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "lt min",
			inputState: xbox360.InputState{
				LT: 0,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "lt mid",
			inputState: xbox360.InputState{
				LT: 128,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "lt max",
			inputState: xbox360.InputState{
				LT: 255,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "rt min",
			inputState: xbox360.InputState{
				RT: 0,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "rt mid",
			inputState: xbox360.InputState{
				RT: 128,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "rt max",
			inputState: xbox360.InputState{
				RT: 255,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "lx min",
			inputState: xbox360.InputState{
				LX: -32768,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "lx mid",
			inputState: xbox360.InputState{
				LX: 0,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "lx max",
			inputState: xbox360.InputState{
				LX: 32767,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "ly min",
			inputState: xbox360.InputState{
				LY: -32768,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "ly mid",
			inputState: xbox360.InputState{
				LY: 0,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "ly max",
			inputState: xbox360.InputState{
				LY: 32767,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "rx min",
			inputState: xbox360.InputState{
				RX: -32768,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "rx mid",
			inputState: xbox360.InputState{
				RX: 0,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "rx max",
			inputState: xbox360.InputState{
				RX: 32767,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "ry min",
			inputState: xbox360.InputState{
				RY: -32768,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "ry mid",
			inputState: xbox360.InputState{
				RY: 0,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "ry max",
			inputState: xbox360.InputState{
				RY: 32767,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "buttons combo",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonA | xbox360.ButtonB | xbox360.ButtonStart | xbox360.ButtonDPadUp,
			},
			expectedReport: []byte{0x00, 0x14, 0x11, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "axes combo",
			inputState: xbox360.InputState{
				LT: 255,
				RT: 128,
				LX: -32768,
				LY: 32767,
				RX: 1234,
				RY: -4321,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0x00, 0xff, 0x80, 0x00, 0x80, 0xff, 0x7f, 0xd2, 0x04, 0x1f, 0xef, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},

		{
			name: "buttons axes combo",
			inputState: xbox360.InputState{
				Buttons: xbox360.ButtonX | xbox360.ButtonY | xbox360.ButtonLShoulder | xbox360.ButtonRShoulder,
				LT:      1,
				RT:      254,
				LX:      111,
				LY:      -222,
				RX:      333,
				RY:      -444,
			},
			expectedReport: []byte{0x00, 0x14, 0x00, 0xc3, 0x01, 0xfe, 0x6f, 0x00, 0x22, 0xff, 0x4d, 0x01, 0x44, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},
	}

	s := viiperTesting.NewTestServer(t)
	defer s.UsbServer.Close()
	defer s.ApiServer.Close()

	r := s.ApiServer.Router()
	r.Register("bus/{id}/add", handler.BusDeviceAdd(s.UsbServer, s.ApiServer))
	r.RegisterStream("bus/{busId}/{deviceid}", api.DeviceStreamHandler(s.UsbServer))

	if err := s.ApiServer.Start(); err != nil {
		t.Fatalf("Failed to start API server: %v", err)
	}

	b, err := virtualbus.NewWithBusId(1)
	if err != nil {
		t.Fatalf("Failed to create virtual bus: %v", err)
	}
	defer b.Close()
	_ = s.UsbServer.AddBus(b)

	client := apiclient.New(s.ApiServer.Addr())
	stream, _, err := client.AddDeviceAndConnect(context.Background(), b.BusID(), "xbox360", nil)
	if !assert.NoError(t, err) {
		return
	}
	defer stream.Close()

	usbipClient := viiperTesting.NewUsbIpClient(t, s.UsbServer.Addr())
	devs, err := usbipClient.ListDevices()
	if !assert.NoError(t, err) {
		return
	}
	if !assert.Len(t, devs, 1) {
		return
	}
	imp, err := usbipClient.AttachDevice(devs[0].BusID)
	if !assert.NoError(t, err) {
		return
	}
	if imp != nil && imp.Conn != nil {
		defer imp.Conn.Close()
	}

	for _, tc := range cases {
		t.Run(tc.name, func(t *testing.T) {
			assert.Equal(t, tc.expectedReport, tc.inputState.BuildReport())
			if !assert.NoError(t, stream.WriteBinary(&tc.inputState)) {
				return
			}
			got, err := usbipClient.PollInputReport(imp.Conn, tc.expectedReport, 750*time.Millisecond)
			if !assert.NoError(t, err) {
				return
			}
			assert.Equal(t, tc.expectedReport, got)
		})
	}

}

func TestRumble(t *testing.T) {

	type testCase struct {
		name        string
		rumbleState xbox360.XRumbleState
		outPacket   []byte
	}
	cases := []testCase{
		{
			name: "off",
			rumbleState: xbox360.XRumbleState{
				LeftMotor:  0,
				RightMotor: 0,
			},
			outPacket: []byte{0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		},
		{
			name: "mid",
			rumbleState: xbox360.XRumbleState{
				LeftMotor:  128,
				RightMotor: 128,
			},
			outPacket: []byte{0x00, 0x08, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00},
		},
		{
			name: "full",
			rumbleState: xbox360.XRumbleState{
				LeftMotor:  255,
				RightMotor: 255,
			},
			outPacket: []byte{0x00, 0x08, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00},
		},
	}

	s := viiperTesting.NewTestServer(t)
	defer s.UsbServer.Close()
	defer s.ApiServer.Close()

	r := s.ApiServer.Router()
	r.Register("bus/{id}/add", handler.BusDeviceAdd(s.UsbServer, s.ApiServer))
	r.RegisterStream("bus/{busId}/{deviceid}", api.DeviceStreamHandler(s.UsbServer))

	if err := s.ApiServer.Start(); err != nil {
		t.Fatalf("Failed to start API server: %v", err)
	}

	b, err := virtualbus.NewWithBusId(1)
	if err != nil {
		t.Fatalf("Failed to create virtual bus: %v", err)
	}
	defer b.Close()
	_ = s.UsbServer.AddBus(b)

	client := apiclient.New(s.ApiServer.Addr())
	stream, _, err := client.AddDeviceAndConnect(context.Background(), b.BusID(), "xbox360", nil)
	if !assert.NoError(t, err) {
		return
	}
	defer stream.Close()

	usbipClient := viiperTesting.NewUsbIpClient(t, s.UsbServer.Addr())
	devs, err := usbipClient.ListDevices()
	if !assert.NoError(t, err) {
		return
	}
	if !assert.Len(t, devs, 1) {
		return
	}
	imp, err := usbipClient.AttachDevice(devs[0].BusID)
	if !assert.NoError(t, err) {
		return
	}
	if imp != nil && imp.Conn != nil {
		defer imp.Conn.Close()
	}

	for _, tc := range cases {
		t.Run(tc.name, func(t *testing.T) {
			if !assert.NoError(t, usbipClient.Submit(imp.Conn, usbip.DirOut, 1, tc.outPacket, nil)) {
				return
			}
			var buf [2]byte
			_ = stream.SetReadDeadline(time.Now().Add(750 * time.Millisecond))
			_, err := io.ReadFull(stream, buf[:])
			if !assert.NoError(t, err) {
				return
			}
			got := xbox360.XRumbleState{LeftMotor: buf[0], RightMotor: buf[1]}
			assert.Equal(t, tc.rumbleState, got)
		})
	}

}
